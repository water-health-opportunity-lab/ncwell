# SUMMARY
# WELL USE
# GEOLOGY PREDICTOR GROUP
# GROUNDWATER PREDICTOR GROUP
# HYDROCLIMATE PREDICTOR GROUP
# SOIL PROPERTIES PREDICTOR GROUP
# LANDSCAPE PREDICTOR VARIABLES 
# REDOX CONDITIONS
# SOIL GEOCHEMISTRY

# read in helper function
source(here::here("script/2_data_wrangling/helper_functions.R"))
library(dplyr)
library(sp)
library(raster)
library(terra)
library(sf)
library(exactextractr)

# WELL USE
welluse <- read.csv("/Users/ellenwei/ncwell/data/input/Well Use/Well_Estimates_2020_Blocks.csv") %>%
  filter(State == "NC")

censusblocknc <- st_read("/Users/ellenwei/ncwell/data/input/nccensusblock/tl_2024_37_tabblock20.shp")

welluse <- welluse %>%
  mutate(GEOID_Block = as.character(GEOID_Block))

welluse_sf <- welluse %>%
  left_join(censusblocknc, by = c("GEOID_Block" = "GEOID20"))

welluse_sf <- welluse_sf[, c("geometry", "Est_Wells_2020", "Pct_Wells", "Pct_Public")]

welluse_sf <- st_as_sf(welluse_sf)

welluse_sf <- st_transform(welluse_sf, st_crs(nc_centroids))

nc_centroids_joined <- st_join(nc_centroids, welluse_sf) %>%
  st_drop_geometry() %>%
  dplyr::select(grid_id, Pct_Wells)

nc_grid <- nc_grid %>%
  left_join(nc_centroids_joined, by = "grid_id")

summary(nc_grid$Pct_Wells)
plot(nc_grid["Pct_Wells"], border = NA)

# GEOLOGY PREDICTOR GROUP
#   - drainage (drainage)
#   - surficial geology (surfgeo) 
#   - bedrock geology (KB)
#   - lithology (lith)

# EXTRACT DRAINAGE
## 1. read in grid shapefile
# read in nc_grid, the common base grid for North Carolina
nc_grid <- st_read("data/output/nc_grid/nc_grid.shp")

# EXTRACT SURFACE GEOLOGY
## 1. nc_grid is already in memory, get grid cell centroids
nc_centroids_geom <- st_centroid(st_geometry(nc_grid))  # this avoids the warning
nc_centroids <- st_sf(nc_grid, geometry = nc_centroids_geom)

## 2. read in drainage raster
drainage_raster <- rast("/Users/ellenwei/ncwell/data/input/Geology/Drainage/usgs_tiledrainage/SubsurfaceDrainExtentUS_90s_agg.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
drainage_raster_reprojected <- project(drainage_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "drainage" needs to match what is in the tracker on OneDrive
nc_grid$drainage <- exact_extract(drainage_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$drainage)
plot(nc_grid['drainage'], border = NA)

#SURFACE GEOLOGY
# EXTRACT SURFACE GEOLOGY
## 2. read in surface geology shapefile
surfgeo_shp <- st_read("/Users/ellenwei/ncwell/data/input/Geology/Surficial Geology/Surficial_materials.shp") %>%
  dplyr::select("UNIT_NAME")

## 3. align CRS
surfgeo_shp_reprojected <- st_transform(surfgeo_shp, st_crs(nc_grid))

## 4. Spatial join: assign polygon attribute(s) to each centroid
# This gives each centroid the value of the polygon it falls in
nc_centroids_joined <- st_join(nc_centroids, surfgeo_shp_reprojected) %>%
  st_drop_geometry() %>%
  dplyr::select(grid_id, surfgeo = UNIT_NAME)

# 5. Merge the joined values back into the original grid
nc_grid <- nc_grid %>%
  left_join(nc_centroids_joined, by = "grid_id")

# check the result
table(nc_grid$surfgeo, useNA = "ifany")
plot(nc_grid['surfgeo'], border = NA)

#BEDROCK GEOLOGY
## 2. read in bedrock geology shapefile
KB_shp <- st_read("/Users/ellenwei/ncwell/data/input/Geology/Bedrock/KBGE/kbge.shp")%>%
  dplyr::select("UNIT")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
KB_shp_reprojected <- st_transform(KB_shp, st_crs(nc_grid))

## 4. Spatial join: assign polygon attribute(s) to each centroid
# This gives each centroid the value of the polygon it falls in
nc_centroids_joined <- st_join(nc_centroids, KB_shp_reprojected) %>%
  st_drop_geometry() %>%
  dplyr::select(grid_id, KB = UNIT)

# 5. Merge the joined values back into the original grid
nc_grid <- nc_grid %>%
  left_join(nc_centroids_joined, by = "grid_id")

# check the result
table(nc_grid$KB, useNA = "ifany")
plot(nc_grid['KB'], border = NA)

# LITHOLOGY
## 2. read in lithology  shapefile
lith_shp <- st_read("/Users/ellenwei/ncwell/data/input/Geology/Lithology/geol_poly.shp") %>%
  dplyr::select("LITH62")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
lith_shp_reprojected <- st_transform(lith_shp, st_crs(nc_grid))

## 4. Spatial join: assign polygon attribute(s) to each centroid
# This gives each centroid the value of the polygon it falls in
nc_centroids_joined <- st_join(nc_centroids, lith_shp_reprojected) %>%
  st_drop_geometry() %>%
  dplyr::select(grid_id, lith = LITH62)

# 5. Merge the joined values back into the original grid
nc_grid <- nc_grid %>%
  left_join(nc_centroids_joined, by = "grid_id")

# check the result
table(nc_grid$lith, useNA = "ifany")
plot(nc_grid['lith'], border = NA)

# GROUNDWATER PREDICTOR GROUP
# Indicators:
#   - Depth to Groundwater (dtw)
#   - Transmissivity (trans)
#   - Unsaturated Zone Travel Time (unsatTT)
#   - Unsaturated Zone Water Content (unsatWC)
#   - Aquifer Rock Type (aq_rocktype)
#   - NO3 DOM
#   - NO3 PUB

### EXTRACT DTW
## 2. read in raster
dtw_raster <- rast("/Users/ellenwei/ncwell/data/input/Groundwater/DTW/conus_MF6_SS_Unconfined_250_dtw.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
dtw_raster_reprojected <- project(dtw_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon# R Script to extract various predictors from raw data in vulnerability module
# exactextractr handles partial overlaps and weighting
# variable name "dtw" needs to match what is in the tracker on OneDrive
nc_grid$dtw <- exact_extract(dtw_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$dtw)
plot(nc_grid['dtw'], border = NA)

## TRANS RASTER
## 2. read in trans raster
trans_raster <- rast("/Users/ellenwei/ncwell/data/input/Groundwater/Transmissivity/conus_MF6_SS_Unconfined_250_trans.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
trans_raster_reprojected <- project(trans_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "trans" needs to match what is in the tracker on OneDrive
nc_grid$trans <- exact_extract(trans_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$trans)
plot(nc_grid['trans'], border = NA)

## UnsatTT RASTER
## 2. read in unsatTT raster
unsatTT_raster <- rast("/Users/ellenwei/ncwell/data/input/Groundwater/TT/conus_MF6_SS_Unconfined_250_tt_total.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
unsatTT_raster_reprojected <- project(unsatTT_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "unsatTT" needs to match what is in the tracker on OneDrive
nc_grid$unsatTT <- exact_extract(unsatTT_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$unsatTT)
plot(nc_grid['unsatTT'], border = NA)

## unsatWC RASTER
## 2. read in unsatWC raster
unsatWC_raster <- rast("/Users/ellenwei/ncwell/data/input/Groundwater/WC/conus_MF6_SS_Unconfined_250_wc_avg.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
unsatWC_raster_reprojected <- project(unsatWC_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "unsatwc" needs to match what is in the tracker on OneDrive
nc_grid$unsatWC <- exact_extract(unsatWC_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$unsatWC)
plot(nc_grid['unsatWC'], border = NA)

### READ IN AQUIFER
aq_rocktype <- st_read("/Users/ellenwei/ncwell/data/input/Groundwater/Aquifer/us_aquifers.shp") %>%
  dplyr::select("AQ_CODE")

## 3. align CRS
aq_rocktype_reprojected <- st_transform(aq_rocktype, st_crs(nc_grid))

## 4. Spatial join: assign polygon attribute(s) to each centroid
# This gives each centroid the value of the polygon it falls in
nc_centroids_geom <- st_centroid(st_geometry(nc_grid))  # this avoids the warning
nc_centroids <- st_sf(nc_grid, geometry = nc_centroids_geom)
nc_centroids_joined <- st_join(nc_centroids, aq_rocktype_reprojected) %>%
  st_drop_geometry() %>%
  dplyr::select(grid_id, aq_rocktype = AQ_CODE)

# 5. Merge the joined values back into the original grid
nc_grid <- nc_grid %>%
  left_join(nc_centroids_joined, by = "grid_id")

# Check 
plot(nc_grid['aq_rocktype'], border = NA)

### READ IN NO3_dom
no3_dom <- rast ("/Users/ellenwei/ncwell/data/input/USGS NO3/no3_doms.asc")

## SET CRS
crs(no3_dom) <- "EPSG:5070"

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
no3_dom_reprojected <- project(no3_dom, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "no3_dom" needs to match what is in the tracker on OneDrive
nc_grid$no3_dom <- exact_extract(no3_dom_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$no3_dom)
plot(nc_grid['no3_dom'], border = NA)

### READ IN NO3_pub
no3_pub <- rast ("/Users/ellenwei/ncwell/data/input/USGS NO3/no3_pubs.asc")

## SET CRS
crs(no3_pub) <- "EPSG:5070"

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
no3_pub_reprojected <- project(no3_pub, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name no3_pub" needs to match what is in the tracker on OneDrive
nc_grid$no3_pub <- exact_extract(no3_pub_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$no3_pub)
plot(nc_grid['no3_pub'], border = NA)

# HYDROCLIMATE PREDICTOR GROUP
#   - Effective Recharge (effrech)
#   - Recharge (rech)
#   - Temperature (tmean)
#   - Precipitation (ppt)
#   - Base-Flow Index (bfi)
#   - Stream Density (stm_den)
#   - Evapotranspiration (ET)
#   - Quickflow (qf) 
#   - HUC-12 (huc12)
#   - Elevation (elevation)

# Read in Effective Recharge
effrech <- rast("/Users/ellenwei/ncwell/data/input/Hydroclimate/reitz_hydrology/0013/RC_eff_0013.tif")

effrech_reprojected <- project(effrech, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "rech" needs to match what is in the tracker on OneDrive
nc_grid$effrech <- exact_extract(effrech_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$effrech)
plot(nc_grid['effrech'], border = NA)

# Read in Recharge Raster
rech <- rast("/Users/ellenwei/ncwell/data/input/Hydroclimate/Recharge (Wolock)/rech48grd-2/rech48grd")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
rech_reprojected <- project(rech, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "rech" needs to match what is in the tracker on OneDrive
nc_grid$rech <- exact_extract(rech_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$rech)
plot(nc_grid['rech'], border = NA)

## Read in Temperature and Precipitation
tmean <- rast ("/Users/ellenwei/ncwell/data/input/Hydroclimate/Temperature/PRISM_tmean_30yr_normal_800mM2_annual_asc.asc")
ppt <- rast ("/Users/ellenwei/ncwell/data/input/Hydroclimate/Precipitation/PRISM_ppt_30yr_normal_800mM2_annual_asc.asc")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
tmean_reprojected <- project(tmean, vect(nc_grid), method = "bilinear")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
ppt_reprojected <- project(ppt, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "tmean" needs to match what is in the tracker on OneDrive
nc_grid$tmean <- exact_extract(tmean_reprojected, nc_grid, 'mean')

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "ppt" needs to match what is in the tracker on OneDrive
nc_grid$ppt <- exact_extract(ppt_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$tmean)
plot(nc_grid['tmean'], border = NA)

# check the result
summary(nc_grid$ppt)
plot(nc_grid['ppt'], border = NA)

# BFI
## 2. read in dtw raster
bfi <- rast("/Users/ellenwei/ncwell/data/input/Hydroclimate/BFI/bfi48grd")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
bfi_reprojected <- project(bfi, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "bfi" needs to match what is in the tracker on OneDrive
nc_grid$bfi <- exact_extract(bfi_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$bfi)
plot(nc_grid['bfi'], border = NA)

### STREAM DENSITY
# Read in stream density
stm_den <- rast("/Users/ellenwei/ncwell/data/input/Hydroclimate/Stream Density/stmdenhuc12")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
stm_den_reprojected <- project(stm_den, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "stm_den" needs to match what is in the tracker on OneDrive
nc_grid$stm_den <- exact_extract(stm_den_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$stm_den)
plot(nc_grid['stm_den'], border = NA)

# Read in Evapotranspiration (ET)
ET <- rast("/Users/ellenwei/ncwell/data/input/Hydroclimate/reitz_hydrology/ET_0013/ET_0013.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
ET_reprojected <- project(ET, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "ET" needs to match what is in the tracker on OneDrive
nc_grid$ET <- exact_extract(ET_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$ET)
plot(nc_grid['ET'], border = NA)

#Read in Quickflow (QF)
qf <- rast("/Users/ellenwei/ncwell/data/input/Hydroclimate/reitz_hydrology/QuickFlow_0013/RO_0013.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
qf_reprojected <- project(qf, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "ET" needs to match what is in the tracker on OneDrive
nc_grid$qf <- exact_extract(qf_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$qf)
plot(nc_grid['qf'], border = NA)

huc12enhanced <- st_read("/Users/ellenwei/ncwell/data/input/Landscape/huc12enhanced.gpkg")

# 2. Align CRS with nc_grid
huc12enhanced <- st_transform(huc12enhanced, st_crs(nc_grid))

# 3. Spatial join: assign HUC12 attributes to each grid cell
nc_grid <- st_join(nc_grid, huc12enhanced, join = st_intersects)

# Elevation
## 2. read in elevation raster
elevation <- rast("/Users/ellenwei/ncwell/data/input/Landscape/Elevation_US.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
elevation_reprojected <- project(elevation, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "elevation" needs to match what is in the tracker on OneDrive
nc_grid$elevation <- exact_extract(elevation_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$elevation)
plot(nc_grid['elevation'], border = NA)

# SOIL PROPERTIES PREDICTOR GROUP
#   - Permeability
#   - T Factor 
#   - Available Water Storage Mean (AWCmean)
#   - Available Water Storage top 25 cm (AWS25)
#   - K Factor
#   - pH
#   - % Sand (sand)
#   - % Clay (clay)
#   - % Organic Matter (om_kg_sq_m)
#   - % Silt (silt)
#   - Soil Temp Regieme (str_int)
#   - Soil Depth (soil_depth)
#   - Cation Exchange Capacity (cec)
#   - Electroconductivity (ec)
#   - Sodium Absorption Ratio (sar)
#   - Wind Erodability Group (weg_int)
#   - Hydrologic Group (hydgrp_int)
#   - Drainage Class (drainage_class_int)
#   - Bulk Density (db)

# READ IN STATSGO
statsgo <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/statsgo/muid")

gssurgo <- "/Users/ellenwei/ncwell/data/input/Soil Geochemistry/gSSURGO_NC.gdb"

component <- st_read(gssurgo, layer = "component")

mupolygon <- st_read(gssurgo, layer = "MUPOLYGON")

tfact_by_mukey <- component %>%
  st_drop_geometry() %>%  # drop geometry to speed up processing
  group_by(mukey) %>%
  summarise(
    weighted_tfact = weighted.mean(tfact, w = comppct_r, na.rm = TRUE)
  )

mupolygon_tfact <- mupolygon %>%
  left_join(tfact_by_mukey, by = c("MUKEY" = "mukey"))

mupolygon_tfact <- st_transform(mupolygon_tfact, st_crs(nc_grid))

nc_centroids_joined <- st_join(nc_centroids, mupolygon_tfact %>% dplyr::select(MUKEY, weighted_tfact)) %>%
  st_drop_geometry() %>%
  dplyr::select(grid_id, weighted_tfact)

# 5. Merge the joined values back into the original grid
nc_grid <- nc_grid %>%
  left_join(nc_centroids_joined, by = "grid_id")

# check the result
summary(nc_grid$weighted_tfact)
plot(nc_grid['weighted_tfact'], border = NA)

chorizon <- st_read(gssurgo, layer = "chorizon")

library(dplyr)

# Remove rows with missing ksat or depth
chorizon_clean <- chorizon %>%
  filter(!is.na(ksat_r), !is.na(hzdept_r), !is.na(hzdepb_r)) %>%
  mutate(thickness_cm = hzdepb_r - hzdept_r)

# Depth-weighted average of ksat_r (permeability) per component (cokey)
permeability_by_cokey <- chorizon_clean %>%
  group_by(cokey) %>%
  summarise(
    weighted_ksat = weighted.mean(ksat_r, w = thickness_cm, na.rm = TRUE)
  )

# Join with component-level permeability
component_perm <- component %>%
  left_join(permeability_by_cokey, by = "cokey")

# Weighted average of permeability (weighted_ksat) per map unit (MUKEY)
perm_by_mukey <- component_perm %>%
  filter(!is.na(weighted_ksat)) %>%
  group_by(mukey) %>%
  summarise(
    weighted_perm = weighted.mean(weighted_ksat, w = comppct_r, na.rm = TRUE)
  )

# Join permeability values to mupolygon by MUKEY
mupolygon_perm <- mupolygon %>%
  left_join(perm_by_mukey, by = c("MUKEY" = "mukey"))

# Transform to match grid CRS
mupolygon_perm <- st_transform(mupolygon_perm, st_crs(nc_grid))

# Join permeability values to grid centroids
nc_centroids_perm <- st_join(nc_centroids, mupolygon_perm %>% dplyr::select(MUKEY, weighted_perm)) %>%
  st_drop_geometry() %>%
  dplyr::select(grid_id, weighted_perm)

# Join permeability back to original grid
nc_grid <- nc_grid %>%
  left_join(nc_centroids_perm, by = "grid_id")

# Check summary and plot
summary(nc_grid$weighted_perm)
plot(nc_grid['weighted_perm'], border = NA)

# EXTRACT WATER STORAGE
## 2. read in water storage raster
waterstorage_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/water_storage.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
waterstorage_raster_reprojected <- project(waterstorage_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "AWCmean" needs to match what is in the tracker on OneDrive
nc_grid$AWCmean <- exact_extract(waterstorage_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$AWCmean)
plot(nc_grid['AWCmean'], border = NA)

# EXTRACT WATER STORAGE TOP 25 
## 2. read in water storage raster
storage25_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/paws_025.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
storage25_raster_reprojected <- project(storage25_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "AWS25" needs to match what is in the tracker on OneDrive
nc_grid$AWS25 <- exact_extract(storage25_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$AWS25)
plot(nc_grid['AWS25'], border = NA)

# EXTRACT K FACTOR
## 2. read in k factor raster
kfact <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/paws_025.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
kfact_reprojected <- project(kfact, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "kfact" needs to match what is in the tracker on OneDrive
nc_grid$kfact <- exact_extract(kfact_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$kfact)
plot(nc_grid['kfact'], border = NA)

# EXTRACT pH
## 2. read in pH raster
pH_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/ph.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
pH_raster_reprojected <- project(pH_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "pH" needs to match what is in the tracker on OneDrive
nc_grid$pH <- exact_extract(pH_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$pH)
plot(nc_grid['pH'], border = NA)

# EXTRACT SAND
## 2. read in sand raster
sand_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/sand.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
sand_raster_reprojected <- project(sand_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "sand" needs to match what is in the tracker on OneDrive
nc_grid$sand <- exact_extract(sand_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$sand)
plot(nc_grid['sand'], border = NA)

# EXTRACT CLAY
## 2. read in clay raster
clay_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/clay.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
clay_raster_reprojected <- project(clay_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "clay" needs to match what is in the tracker on OneDrive
nc_grid$clay <- exact_extract(clay_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$clay)
plot(nc_grid['clay'], border = NA)

# EXTRACT SOIL ORGANIC MATTER
## 2. read in om_kg_sq_m raster
om_kg_sq_m_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/om_kg_sq_m.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
om_kg_sq_m_raster_reprojected <- project(om_kg_sq_m_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "om_kg_sq_m" needs to match what is in the tracker on OneDrive
nc_grid$om_kg_sq_m <- exact_extract(om_kg_sq_m_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$om_kg_sq_m)
plot(nc_grid['om_kg_sq_m'], border = NA)

# EXTRACT SILT
## 2. read in silt raster
silt_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/silt.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
silt_raster_reprojected <- project(silt_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "silt" needs to match what is in the tracker on OneDrive
nc_grid$silt <- exact_extract(silt_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$silt)
plot(nc_grid['silt'], border = NA)

#   - Soil Temp Regieme (str_int)
## 2. read in str_int raster
str_int_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/str_int.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
str_int_raster_reprojected <- project(str_int_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "str_int" needs to match what is in the tracker on OneDrive
nc_grid$str_int <- exact_extract(str_int_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$str_int)
plot(nc_grid['str_int'], border = NA)

#   - Soil Depth (soil_depth)
## 2. read in soil_depth raster
soil_depth_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/soil_depth.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
soil_depth_raster_reprojected <- project(soil_depth_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "soil_depth" needs to match what is in the tracker on OneDrive
nc_grid$soil_depth <- exact_extract(soil_depth_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$soil_depth)
plot(nc_grid['soil_depth'], border = NA)

#   - Cation Exchange Capacity (cec)
## 2. read in cec raster
cec_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/cec.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
cec_raster_reprojected <- project(cec_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "cec" needs to match what is in the tracker on OneDrive
nc_grid$cec <- exact_extract(cec_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$cec)
plot(nc_grid['cec'], border = NA)

#   - Electroconductivity (ec)
## 2. read in ec raster
ec_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/ec.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
ec_raster_reprojected <- project(ec_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "ec" needs to match what is in the tracker on OneDrive
nc_grid$ec <- exact_extract(ec_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$ec)
plot(nc_grid['ec'], border = NA)

#   - Sodium Absorption Ratio (sar)
## 2. read in sar raster
sar_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/sar.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
sar_raster_reprojected <- project(sar_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "sar" needs to match what is in the tracker on OneDrive
nc_grid$sar <- exact_extract(sar_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$sar)
plot(nc_grid['sar'], border = NA)

#   - Wind Erodability Group (weg_int)
## 2. read in weg_int raster
weg_int_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/weg_int.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
weg_int_raster_reprojected <- project(weg_int_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "weg_int" needs to match what is in the tracker on OneDrive
nc_grid$weg_int <- exact_extract(weg_int_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$weg_int)
plot(nc_grid['weg_int'], border = NA)

#   - Hydrologic Group (hydgrp_int)
## 2. read in weg_int raster
hydgrp_int_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/hydgrp_int.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
hydgrp_int_raster_reprojected <- project(hydgrp_int_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "hydgrp_int" needs to match what is in the tracker on OneDrive
nc_grid$hydgrp_int<- exact_extract(hydgrp_int_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$hydgrp_int)
plot(nc_grid['hydgrp_int'], border = NA)

#   - Drainage Class (drainage_class_int)
## 2. read in drainage_class_int raster
drainage_class_int_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/drainage_class_int.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
drainage_class_int_raster_reprojected <- project(drainage_class_int_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "drainage_class_int" needs to match what is in the tracker on OneDrive
nc_grid$drainage_class_int <- exact_extract(drainage_class_int_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$drainage_class_int)
plot(nc_grid['drainage_class_int'], border = NA)

#   - Bulk Density (db)
## 2. read in db raster
db_raster <- rast("/Users/ellenwei/ncwell/data/input/Soil Properties/soil_properties/db.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
db_raster_reprojected <- project(db_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "db" needs to match what is in the tracker on OneDrive
nc_grid$db <- exact_extract(db_raster_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$db)
plot(nc_grid['db'], border = NA)

### LANDSCAPE PREDICTOR VARIABLES 
##LANDCOVER CLASS 
landcover <- rast("/Users/ellenwei/ncwell/data/input/Landscape/NC_NLCD2019only/nc_nlcd2019")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
landcover_reprojected <- project(landcover, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "landcover" needs to match what is in the tracker on OneDrive
nc_grid$landcover <- exact_extract(landcover_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$landcover)
plot(nc_grid['landcover'], border = NA)

### USDA LAND USE STRATA
## 2. read in landuse  shapefile
landuse_shp <- st_read("/Users/ellenwei/ncwell/data/input/Landscape/NC_strata_17/NC_strata_17.shp")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
landuse_shp_reprojected <- st_transform(landuse_shp, st_crs(nc_grid))

## 4. Spatial join: assign polygon attribute(s) to each centroid
# This gives each centroid the value of the polygon it falls in
nc_centroids_joined <- st_join(nc_centroids, landuse_shp_reprojected) %>%
  st_drop_geometry() %>%
  dplyr::select(grid_id, landuse = "Strata")

# 5. Merge the joined values back into the original grid
nc_grid <- nc_grid %>%
  left_join(nc_centroids_joined, by = "grid_id")

# check the result
table(nc_grid$landuse, useNA = "ifany")
plot(nc_grid['landuse'], border = NA)

### Redox Conditions
## 2. read in redox_Mn raster
redox_Mn <- rast("/Users/ellenwei/ncwell/data/input/Redox/mn.tiff")
oxic <- rast("/Users/ellenwei/ncwell/data/input/Redox/redox.tiff")

crs(redox_Mn) <- "EPSG:4326"
crs(oxic) <- "EPSG:4326"

# Step 1: Make a template raster from nc_grid
template_raster <- rast(nc_grid)

# Step 2: Project redox_Mn to match that template (including extent and resolution)
redox_Mn_reprojected <- project(redox_Mn, template_raster, method = "bilinear")
oxic_reprojected <- project(oxic, template_raster, method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "redox_Mn" needs to match what is in the tracker on OneDrive
nc_grid$redox_Mn <- exact_extract(redox_Mn_reprojected, nc_grid, 'mean')
nc_grid$oxic <- exact_extract(oxic_reprojected, nc_grid, 'mean')

# check the result
summary(nc_grid$redox_Mn)
plot(nc_grid['redox_Mn'], border = NA)

# check the result
summary(nc_grid$oxic)
plot(nc_grid['oxic'], border = NA)

# SOIL GEOCHEMISTRY
geochem <- st_read("/Users/ellenwei/ncwell/data/input/Soil Geochemistry/nc_grid_geochem.gpkg")

geochem_no_geom <- st_set_geometry(geochem, NULL)

nc_grid <- nc_grid %>%
  left_join(geochem_no_geom, by = "grid_id")

#WRITE OUT RESULTS 
st_write(nc_grid, "data/output/nc_grid_vulnerability_full.gpkg", layer = "vulnerability", delete_layer = TRUE)