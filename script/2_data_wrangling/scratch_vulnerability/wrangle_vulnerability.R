# ----------------------------------------
# R Script to extract various predictors from raw data in vulnerability module
# Indicators:
#   - drainage
#   - surficial geology
# Author: Xindi Hu
# Last edited: 2025-04-22
# ----------------------------------------
# read in helper function
source(here::here("script/2_data_wrangling/helper_functions.R"))

# EXTRACT DRAINAGE
## 1. read in grid shapefile
# read in nc_grid, the common base grid for North Carolina
nc_grid <- st_read("data/output/nc_grid/nc_grid.shp")

## 2. read in drainage raster
drainage_raster <- rast("data/input/usgs_tiledrainage/SubsurfaceDrainExtentUS_90s_agg.tif")

## 3. align CRS
# reproject raster to match the coordinate reference system of nc_grid
drainage_raster_reprojected <- project(drainage_raster, vect(nc_grid), method = "bilinear")

## 4. extract raster values using mean per polygon
# exactextractr handles partial overlaps and weighting
# variable name "drainage" needs to match what is in the tracker on OneDrive
nc_grid$drainage <- exact_extract(drainage_raster_reprojected, nc_grid, 'mean')
# check the result
summary(nc_grid$drainage)
plot(nc_grid['drainage'], border = NA)

# EXTRACT SURFACE GEOLOGY
## 1. nc_grid is already in memory, get grid cell centroids
nc_centroids_geom <- st_centroid(st_geometry(nc_grid))  # this avoids the warning
nc_centroids <- st_sf(nc_grid, geometry = nc_centroids_geom)

## 2. read in surface geology shapefile
surfgeo_shp <- st_read("data/input/Soller_surfgeo/USGS_DS_425_SHAPES/Surficial_materials.shp") %>%
  select("UNIT_NAME")

## 3. align CRS
surfgeo_shp_reprojected <- st_transform(surfgeo_shp, st_crs(nc_grid))

## 4. Spatial join: assign polygon attribute(s) to each centroid
# This gives each centroid the value of the polygon it falls in
nc_centroids_joined <- st_join(nc_centroids, surfgeo_shp_reprojected) %>%
  st_drop_geometry() %>%
  dplyr::select(grid_id, surfgeo = UNIT_NAME)

# 5. Merge the joined values back into the original grid
nc_grid <- nc_grid %>%
  left_join(nc_centroids_joined, by = "grid_id")

# check the result
table(nc_grid$surfgeo, useNA = "ifany")
plot(nc_grid['surfgeo'], border = NA)


#WRITE OUT RESULTS 
st_write(nc_grid, "data/output/nc_grid_vulnerability.gpkg", layer = "vulnerability", delete_layer = TRUE)


