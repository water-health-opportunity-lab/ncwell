# ----------------------------------------
# R Script to fill in missing data with K Nearest Neighbors imputation for Vulnerability Module
# Author: Jennifer Zhang
# Last edited: 2025-07-08
# ----------------------------------------

library(sf)
library(dplyr)
library(ggplot2)
library(FNN)
library(modeest)

# Read in data from module
data <- st_read('nc_grid_vulnerability_transformed_no_impute.gpkg')

# Imputation vectors
cat_vars <- c("surfgeo", "KB", "drainage", "aq_rocktype", "ec", 'lith', "sar", "weg_int", 
              "hydgrp_int", "drainage_class_int", "landuse", 'landcover', 'str_int',
              'ec', 'sar')

cont_vars <- c("dtw", "trans", "unsatTT", "unsatWC", "no3_dom", "no3_pub", "rech", "bfi", "stm_den", "ET", "rfor9045", 
                 "PIMPV", "PDEV", "PWETL95", "PFOR", "PFOR90", "PAGP", "Avg_Buff_Width", "AWCmean", "kfact", "pH", 
                 "clay", "om_kg_sq_m", "silt", "cec", "db", "weighted_tfact", "weighted_perm")

# Put centroids in a second geometry column
data$centroids <- st_centroid(data$geom)
coords <- st_coordinates(data$centroids)

# Impute Pct_Wells with 0
data$Pct_Wells[is.na(data$Pct_Wells)] <- 0

# Impute data with K Nearest Neighbors algorithm
# ----------------------------------------
data <- data %>% mutate(row_id = row_number())  # preserve row order

k_choice = 5

# Impute categorical variables
for (var in cat_vars){
  na_rows <- which(is.na(data[[var]]))
  complete_rows <- which(!is.na(data[[var]]))
  
  nn <- get.knnx(data = coords[complete_rows, ], query = coords[na_rows, ], k = k_choice)
  neighbors <- nn$nn.index
  
  for (j in seq_along(na_rows)){
    i <- na_rows[j]
    neighbor_idx <- complete_rows[neighbors[j, ]]
    selected_vals <- data[[var]][neighbor_idx]
    
    data[[var]][i] <- mfv(selected_vals, na_rm = TRUE)
  }
}

# Impute continuous variables
for (var in cont_vars){
  na_rows <- which(is.na(data[[var]]))
  complete_rows <- which(!is.na(data[[var]]))
  
  nn <- get.knnx(data = coords[complete_rows, ], query = coords[na_rows, ], k = k_choice)
  neighbors <- nn$nn.index
  
  for (j in seq_along(na_rows)){
    i <- na_rows[j]
    neighbor_idx <- complete_rows[neighbors[j, ]]
    selected_vals <- data[[var]][neighbor_idx]
    
    data[[var]][i] <- median(selected_vals, na.rm = TRUE)
  }
}

data <- data %>% select(-row_id)

# Check results
# plot(data['aq_rocktype'], border=NA)
# plot(data['weighted_tfact'], border=NA)
# colSums(is.na(data))

st_write(data, "nc_grid_vulnerability_imputed.gpkg", layer="vulnerability", delete_layer=TRUE)