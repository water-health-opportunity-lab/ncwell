# ----------------------------------------
# R Script to fill in missing data with K Nearest Neighbors imputation for Vulnerability Module
# Author: Jennifer Zhang
# Last edited: 2025-07-08
# ----------------------------------------

library(sf)
library(dplyr)
library(ggplot2)
library(FNN)
library(modeest)

# Drop Pct_Wells
data$Pct_Wells <- NULL

# Imputation vectors
cat_vars <- c("surfgeo", "KB", "drainage", "aq_rocktype", "ec", "sar", "weg_int", "hydgrp_int", "drainage_class_int")

cont_vars <- c("dtw", "trans", "unsatTT", "unsatWC", "no3_dom", "no3_pub", "rech", "bfi", "stm_den", "ET", "rfor9045", 
                 "PIMPV", "PDEV", "PWETL95", "PFOR", "PFOR90", "PAGP", "Avg_Buff_Width", "AWCmean", "kfact", "pH", 
                 "clay", "om_kg_sq_m", "silt", "cec", "db", "landcover", "landuse", "weighted_tfact", "weighted_perm")

# Read in data from module
data <- st_read('nc_grid_vulnerability_transformed_no_impute.gpkg')

# Put centroids in a second geometry column
data$centroids <- st_centroid(data$geom)
coords <- st_coordinates(data$centroids)

# Add coordinates
# data$x_coord <- coords[, 1]
# data$y_coord <- coords[, 2]

# Impute data with K Nearest Neighbors algorithm
# ----------------------------------------
data <- data %>% mutate(row_id = row_number())  # preserve row order
# coords <- as.matrix(data[, c(x_coord, y_coord)])

# Find K nearest neighbors for all rows
nn <- get.knnx(data = coords, query = coords, k = 6)  # +1 to exclude self
neighbors <- nn$nn.index[, -1]  # remove self-neighbor (first column)

impute_value <- function(values, var_type = "cont") {
  if (var_type == "cont") {
    return(mean(values, na.rm = TRUE))
  } else {
    return(mfv(values, na_rm = TRUE))
  }
}

# Impute categorical variables
for (var in cat_vars) {
  missing_idx <- which(is.na(data[[var]]))
  for (i in missing_idx) {
    neighbor_vals <- data[[var]][neighbors[i, ]]
    data[[var]][i] <- impute_value(neighbor_vals, var_type = "cat")
  }
}

# Impute continuous variables
for (var in cont_vars) {
  missing_idx <- which(is.na(data[[var]]))
  for (i in missing_idx) {
    neighbor_vals <- data[[var]][neighbors[i, ]]
    data[[var]][i] <- impute_value(neighbor_vals, var_type = "cont")
  }
}

data <- data %>% select(-row_id)

# Check results
# plot(data['aq_rocktype'], border=NA)
# plot(data['weighted_tfact'], border=NA)
# colSums(is.na(data))

st_write(data, "data/output/nc_grid_vulnerability_imputed.gpkg", layer="vulnerability", delete_layer=TRUE)