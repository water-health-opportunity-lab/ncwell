---
title: "Validation of overall risk index using NCDHHS E. coli testing results"
format: html
toc: true
editor: visual
code-fold: true
warning: false 
message: false
self-contained: true
tabset: true
---

```{r}
# ----------------------------------------
# R Script to validate overall risk index using NCDHHS E. coli testing results
# Author: Jennifer Zhang
# Last edited: 2025-07-23
# ----------------------------------------
```

### 1. Load packages and data

First, we load the data below and prepare it for the analysis.

```{r, include=FALSE}
# Load packages
library(sf)
library(dplyr)
library(ggplot2)
library(ROCit)
library(cutpointr)

# Read files
risk <- st_read("nc_grid_index.gpkg")

risk_capacity <- st_read("index_capacity.gpkg")
risk_hazard <- st_read("index_hazard.gpkg")
risk_vulnerability <- st_read("index_vulnerability.gpkg")

ecoli_data <- read.csv("ecoli_coords.csv")

# Join NCDHHS and risk index
ecoli_sf <- st_as_sf(ecoli_data, coords = c("Longitude", "Latitude"), crs = 4326)
ecoli_proj <- st_transform(ecoli_sf, st_crs(risk))
ecoli_with_risk <- st_join(ecoli_proj, risk, join = st_within)
```

The plot of well sampling sites below shows that most of the samples were taken from western counties in North Carolina. The table of well sampling frequencies reveals that Ashe County, Wautaga County, and Henderson County have the largest sample sizes.

```{r}
plot(st_geometry(risk), col = 'lightblue', border = NA)
plot(st_geometry(ecoli_proj), col = 'red', add = TRUE)

sort(table(ecoli_with_risk$System_Name), decreasing = TRUE)
```

Some of the addresses were not fully reported (i.e. only street or road names were included in the NCDHHS report) and this was reflected after geocoding. We may want to filter out inaccurately geocoded testing locations based on the Accuracy column. The Geod.io documentation suggests using a minimum accuracy threshold of 0.8.

Continuous E. coli and Coliform testing results were binarized.

```{r}
# Filter out inaccurately geocoded testing locations
# UPDATE BASED ON WHETHER FILTERING IS NECESSARY

# Turn test results into yes/no
ecoli_binary <- ecoli_with_risk %>%
  mutate(Ecoli_Result_Binary = ifelse(trimws(Ecoli_Result) == "<1", "Absent", "Present")) %>%
  mutate(Coliform_Result_Binary = ifelse(trimws(Total_Coliform_Result) == "<1", "Absent", "Present")) %>%
  filter(!is.na(risk))
```

```{r}
# Map with well testing results overlaid on risk map
# UPDATE WITH MAP SHOWING WELL TESTING RESULTS WITH RISK MAP
```

### 2.1.1 Risk index distribution for E. coli

For E. coli, there are 514 contaminated samples and 38 uncontaminated samples. Based on the histogram and Shapiro-Wilk tests, the distribution of the risk index for both contaminated and uncontaminated samples was non-normal.

```{r}
table(ecoli_binary$Ecoli_Result_Binary)
by(ecoli_binary$risk, ecoli_binary$Ecoli_Result_Binary, summary)

ggplot(ecoli_binary) +
  aes(x = Ecoli_Result_Binary, y = risk, color = Ecoli_Result_Binary) +
  ggdist::stat_halfeye(aes(fill = Ecoli_Result_Binary),
                       adjust = 0.5, width = 0.6, .width = 0, 
                       justification = -0.3) + 
  geom_boxplot(width = .25, outlier.shape = NA) +
  geom_point(size = 1.5, alpha = 0.2, 
             position = position_jitter(seed = 1, width = .1)) +
  theme_minimal()

hist(subset(ecoli_binary, Ecoli_Result_Binary == "Present")$risk,
  main = "Risk index for contaminated wells",
  xlab = "Risk index"
)

hist(subset(ecoli_binary, Ecoli_Result_Binary == "Absent")$risk,
  main = "Risk index for non-contaminated wells",
  xlab = "Risk index"
)

shapiro.test(subset(ecoli_binary, Ecoli_Result_Binary == "Present")$risk)
shapiro.test(subset(ecoli_binary, Ecoli_Result_Binary == "Absent")$risk)
```

### 2.1.2 Wilcoxon rank-sum test for all counties

There is no significant difference between the mean risk index for contaminated and uncontaminated samples.

```{r}
result <- wilcox.test(ecoli_binary$risk ~ ecoli_binary$Ecoli_Result_Binary,
                      alternative = "less")

# result <- t.test(ecoli_binary$risk[ecoli_binary$Ecoli_Result_Binary == "Present"],
#                  ecoli_binary$risk[ecoli_binary$Ecoli_Result_Binary == "Absent"],
#                  var.equal = TRUE, alternative = "greater")

result
```

### 2.2.1 Risk index distribution for Total Coliform

For Coliform, there are 540 contaminated samples and 12 uncontaminated samples. Based on the histogram and Shapiro-Wilk tests, the distribution of the risk index for contaminated samples was non-normal, while the distribution for uncontaminated samples was normal.

```{r}
table(ecoli_binary$Coliform_Result_Binary)
by(ecoli_binary$risk, ecoli_binary$Coliform_Result_Binary, summary)

ggplot(ecoli_binary) +
  aes(x = Coliform_Result_Binary, y = risk, color = Coliform_Result_Binary) +
  ggdist::stat_halfeye(aes(fill = Coliform_Result_Binary),
                       adjust = 0.5, width = 0.6, .width = 0, 
                       justification = -0.3) + 
  geom_boxplot(width = .25, outlier.shape = NA) +
  geom_point(size = 1.5, alpha = 0.2, 
             position = position_jitter(seed = 1, width = .1)) +
  theme_minimal()

hist(subset(ecoli_binary, Coliform_Result_Binary == "Present")$risk,
  main = "Risk index for contaminated wells",
  xlab = "Risk index"
)

hist(subset(ecoli_binary, Coliform_Result_Binary == "Absent")$risk,
  main = "Risk index for non-contaminated wells",
  xlab = "Risk index"
)

shapiro.test(subset(ecoli_binary, Coliform_Result_Binary == "Present")$risk)
shapiro.test(subset(ecoli_binary, Coliform_Result_Binary == "Absent")$risk)
```

### 2.2.2 Wilcoxon rank-sum test for all counties

There is a significant difference between the mean risk index for contaminated and uncontaminated samples. The risk index may reflect overall Coliform contamination better than E. coli contamination.

```{r}
result <- wilcox.test(ecoli_binary$risk ~ ecoli_binary$Coliform_Result_Binary,
                      alternative = "less")

# result <- t.test(ecoli_binary$risk[ecoli_binary$Ecoli_Result_Binary == "Present"],
#                  ecoli_binary$risk[ecoli_binary$Ecoli_Result_Binary == "Absent"],
#                  var.equal = TRUE, alternative = "greater")

result
```

## 3. Logistic regression

```{r}
ecoli_binary <- ecoli_binary %>%
                mutate(Ecoli_Result_Binary = ifelse(Ecoli_Result_Binary == "Absent", 0, 1)) %>%
                mutate(Coliform_Result_Binary = ifelse(Coliform_Result_Binary == "Absent", 0, 1))

log_model_ecoli <- glm(Ecoli_Result_Binary ~ risk, data = ecoli_binary, family = "binomial")
summary(log_model_ecoli)
# exp(coef(log_model)["risk"])

multi_log_ecoli <- glm(Ecoli_Result_Binary ~ index_vulnerability + index_hazard + index_capacity, data = ecoli_binary, family = "binomial")
summary(multi_log_ecoli)

log_model_coliform <- glm(Coliform_Result_Binary ~ risk, data = ecoli_binary, family = "binomial")
summary(log_model_coliform)
# exp(coef(log_model)["risk"])

multi_log_coliform <- glm(Coliform_Result_Binary ~ index_vulnerability + index_hazard + index_capacity, data = ecoli_binary, family = "binomial")
summary(multi_log_coliform)
```

## 4. Threshold for risk index cutoff

Youden's J statistic was used to compute the cutoff threshold for contaminated vs. uncontaminated samples. The cutoff was 0.1849 for E. coli and 0.1847 for Coliform.

```{r}
# ROC with Youden's J statistic
ROCit_obj_ecoli <- rocit(score = ecoli_binary$risk, class = ecoli_binary$Ecoli_Result_Binary)
plot(ROCit_obj_ecoli)

ROCit_obj_coliform <- rocit(score = ecoli_binary$risk, class = ecoli_binary$Coliform_Result_Binary)
plot(ROCit_obj_coliform)

# Risk index cutoff for E. coli test result
ecoli_cp <- cutpointr(ecoli_binary, risk, Ecoli_Result_Binary, direction = ">=", method = maximize_metric, metric = youden, na.rm = TRUE)

summary(ecoli_cp)

# Risk index cutoff for Coliform test result
coliform_cp <- cutpointr(ecoli_binary, risk, Coliform_Result_Binary, direction = ">=", method = maximize_metric, metric = youden, na.rm = TRUE)

summary(coliform_cp)
```
